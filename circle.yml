machine:
  services:
    - docker

dependencies:
  pre:
    - echo $CLIENT_SECRET | base64 --decode > ${HOME}/client-secret.json
    - gcloud --quiet components update
    - gcloud auth activate-service-account --key-file ${HOME}/client-secret.json
    - gcloud config set project $GCP_PROJECT
    - gcloud container clusters get-credentials festival
    - docker build -t $GCP_REGISTRY_ENDPOINT/$GCP_PROJECT/festival-proxy:v$CIRCLE_BUILD_NUM .

deployment:
  release:
    branch: feature/introduce-circleci
    commands:
      - gcloud docker push $GCP_REGISTRY_ENDPOINT/$GCP_PROJECT/festival-proxy:v$CIRCLE_BUILD_NUM
      - kubectl rolling-update proxy --image=$GCP_REGISTRY_ENDPOINT/$GCP_PROJECT/festival-proxy:v$CIRCLE_BUILD_NUM

