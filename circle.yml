machine:
  services:
    - docker

dependencies:
  pre:
    - echo $CLIENT_SECRET | base64 --decode > ${HOME}/client-secret.json
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update kubectl
    - sudo chmod 757 /home/ubuntu/.config/gcloud/logs -R
    - gcloud auth activate-service-account --key-file ${HOME}/client-secret.json
    - gcloud config set compute/zone $GCP_ZONE
    - gcloud config set project $GCP_PROJECT
    - gcloud container clusters get-credentials festival
    - docker build -t $GCP_REGISTRY_ENDPOINT/$GCP_PROJECT/festival-proxy:v$CIRCLE_BUILD_NUM .

test:
  override:
    - docker run -d -p 80:80 $GCP_REGISTRY_ENDPOINT/$GCP_PROJECT/festival-proxy:v$CIRCLE_BUILD_NUM; sleep 10
    - curl --retry 10 --retry-delay 5 -v http://localhost

deployment:
  release:
    branch: feature/introduce-circleci
    commands:
      - gcloud docker push $GCP_REGISTRY_ENDPOINT/$GCP_PROJECT/festival-proxy:v$CIRCLE_BUILD_NUM
      - kubectl rolling-update proxy --image=$GCP_REGISTRY_ENDPOINT/$GCP_PROJECT/festival-proxy:v$CIRCLE_BUILD_NUM

